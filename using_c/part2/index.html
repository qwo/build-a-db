<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Part 2 - World&#39;s Simplest SQL Compiler and Virtual Machine - Build a database in X</title><meta name=description content="Learn By Building"><meta name=generator content="Hugo 0.58.3"><link href=https://build-a-db.stanzheng.com/index.xml rel=alternate type=application/rss+xml><link rel=canonical href=https://build-a-db.stanzheng.com/using_c/part2/><link rel=stylesheet href=https://build-a-db.stanzheng.com/css/theme.min.css><script src=https://use.fontawesome.com/releases/v5.0.6/js/all.js></script><link rel=stylesheet href=https://build-a-db.stanzheng.com/css/chroma.min.css><script src=https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js></script><script src=https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js></script><script src=https://build-a-db.stanzheng.com/js/bundle.js></script><style>:root{}</style></head><body><div class=container><header><h1>Build a database in X</h1><span class=version>Version 1.0.0</span><p class=description>Learn By Building</p></header><div class=global-menu><nav><ul><li><a href=/>Home</a></li><li><a href=https://github.com/stanzheng/build-a-db>Github</a></li><li><a href=https://twitter.com/stanzheng>Twitter</a></li></ul></nav></div><div class=content-container><main><h1>Part 2 - World&#39;s Simplest SQL Compiler and Virtual Machine</h1><p>We&rsquo;re making a clone of sqlite. The &ldquo;front-end&rdquo; of sqlite is a SQL compiler that parses a string and outputs an internal representation called bytecode.</p><p>This bytecode is passed to the virtual machine, which executes it.</p><p><img src=/assets/images/arch2.gif description="SQLite Architecture (https://www.sqlite.org/arch.html)"></p><p>Breaking things into two steps like this has a couple advantages:
- Reduces the complexity of each part (e.g. virtual machine does not worry about syntax errors)
- Allows compiling common queries once and caching the bytecode for improved performance</p><p>With this in mind, let&rsquo;s refactor our <code>main</code> function and support two new keywords in the process:</p><div class=highlight><pre class=chroma><code class=language-diff data-lang=diff> int main(int argc, char* argv[]) {
   InputBuffer* input_buffer = new_input_buffer();
   while (true) {
     print_prompt();
     read_input(input_buffer);

<span class=gd>-    if (strcmp(input_buffer-&gt;buffer, &#34;.exit&#34;) == 0) {
</span><span class=gd>-      exit(EXIT_SUCCESS);
</span><span class=gd>-    } else {
</span><span class=gd>-      printf(&#34;Unrecognized command &#39;%s&#39;.\n&#34;, input_buffer-&gt;buffer);
</span><span class=gd></span><span class=gi>+    if (input_buffer-&gt;buffer[0] == &#39;.&#39;) {
</span><span class=gi>+      switch (do_meta_command(input_buffer)) {
</span><span class=gi>+        case (META_COMMAND_SUCCESS):
</span><span class=gi>+          continue;
</span><span class=gi>+        case (META_COMMAND_UNRECOGNIZED_COMMAND):
</span><span class=gi>+          printf(&#34;Unrecognized command &#39;%s&#39;\n&#34;, input_buffer-&gt;buffer);
</span><span class=gi>+          continue;
</span><span class=gi>+      }
</span><span class=gi></span>     }
<span class=gi>+
</span><span class=gi>+    Statement statement;
</span><span class=gi>+    switch (prepare_statement(input_buffer, &amp;statement)) {
</span><span class=gi>+      case (PREPARE_SUCCESS):
</span><span class=gi>+        break;
</span><span class=gi>+      case (PREPARE_UNRECOGNIZED_STATEMENT):
</span><span class=gi>+        printf(&#34;Unrecognized keyword at start of &#39;%s&#39;.\n&#34;,
</span><span class=gi>+               input_buffer-&gt;buffer);
</span><span class=gi>+        continue;
</span><span class=gi>+    }
</span><span class=gi>+
</span><span class=gi>+    execute_statement(&amp;statement);
</span><span class=gi>+    printf(&#34;Executed.\n&#34;);
</span><span class=gi></span>   }
 }
</code></pre></div><p>Non-SQL statements like <code>.exit</code> are called &ldquo;meta-commands&rdquo;. They all start with a dot, so we check for them and handle them in a separate function.</p><p>Next, we add a step that converts the line of input into our internal representation of a statement. This is our hacky version of the sqlite front-end.</p><p>Lastly, we pass the prepared statement to <code>execute_statement</code>. This function will eventually become our virtual machine.</p><p>Notice that two of our new functions return enums indicating success or failure:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>typedef</span> <span class=k>enum</span> <span class=p>{</span>
  <span class=n>META_COMMAND_SUCCESS</span><span class=p>,</span>
  <span class=n>META_COMMAND_UNRECOGNIZED_COMMAND</span>
<span class=p>}</span> <span class=n>MetaCommandResult</span><span class=p>;</span>

<span class=k>typedef</span> <span class=k>enum</span> <span class=p>{</span> <span class=n>PREPARE_SUCCESS</span><span class=p>,</span> <span class=n>PREPARE_UNRECOGNIZED_STATEMENT</span> <span class=p>}</span> <span class=n>PrepareResult</span><span class=p>;</span></code></pre></div><p>&ldquo;Unrecognized statement&rdquo;? That seems a bit like an exception. But <a href="https://www.youtube.com/watch?v=EVhCUSgNbzo">exceptions are bad</a> (and C doesn&rsquo;t even support them), so I&rsquo;m using enum result codes wherever practical. The C compiler will complain if my switch statement doesn&rsquo;t handle a member of the enum, so we can feel a little more confident we handle every result of a function. Expect more result codes to be added in the future.</p><p><code>do_meta_command</code> is just a wrapper for existing functionality that leaves room for more commands:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>MetaCommandResult</span> <span class=nf>do_meta_command</span><span class=p>(</span><span class=n>InputBuffer</span><span class=o>*</span> <span class=n>input_buffer</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>,</span> <span class=s>&#34;.exit&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_SUCCESS</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>META_COMMAND_UNRECOGNIZED_COMMAND</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span></code></pre></div><p>Our &ldquo;prepared statement&rdquo; right now just contains an enum with two possible values. It will contain more data as we allow parameters in statements:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>typedef</span> <span class=k>enum</span> <span class=p>{</span> <span class=n>STATEMENT_INSERT</span><span class=p>,</span> <span class=n>STATEMENT_SELECT</span> <span class=p>}</span> <span class=n>StatementType</span><span class=p>;</span>

<span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
  <span class=n>StatementType</span> <span class=n>type</span><span class=p>;</span>
<span class=p>}</span> <span class=n>Statement</span><span class=p>;</span></code></pre></div><p><code>prepare_statement</code> (our &ldquo;SQL Compiler&rdquo;) does not understand SQL right now. In fact, it only understands two words:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=n>PrepareResult</span> <span class=nf>prepare_statement</span><span class=p>(</span><span class=n>InputBuffer</span><span class=o>*</span> <span class=n>input_buffer</span><span class=p>,</span>
                                <span class=n>Statement</span><span class=o>*</span> <span class=n>statement</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>strncmp</span><span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>,</span> <span class=s>&#34;insert&#34;</span><span class=p>,</span> <span class=mi>6</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>statement</span><span class=o>-&gt;</span><span class=n>type</span> <span class=o>=</span> <span class=n>STATEMENT_INSERT</span><span class=p>;</span>
    <span class=k>return</span> <span class=n>PREPARE_SUCCESS</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>,</span> <span class=s>&#34;select&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>statement</span><span class=o>-&gt;</span><span class=n>type</span> <span class=o>=</span> <span class=n>STATEMENT_SELECT</span><span class=p>;</span>
    <span class=k>return</span> <span class=n>PREPARE_SUCCESS</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=n>PREPARE_UNRECOGNIZED_STATEMENT</span><span class=p>;</span>
<span class=p>}</span></code></pre></div><p>Note that we use <code>strncmp</code> for &ldquo;insert&rdquo; since the &ldquo;insert&rdquo; keyword will be followed by data. (e.g. <code>insert 1 cstack foo@bar.com</code>)</p><p>Lastly, <code>execute_statement</code> contains a few stubs:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=nf>execute_statement</span><span class=p>(</span><span class=n>Statement</span><span class=o>*</span> <span class=n>statement</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>switch</span> <span class=p>(</span><span class=n>statement</span><span class=o>-&gt;</span><span class=n>type</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>case</span> <span class=p>(</span><span class=n>STATEMENT_INSERT</span><span class=p>)</span><span class=o>:</span>
      <span class=n>printf</span><span class=p>(</span><span class=s>&#34;This is where we would do an insert.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
      <span class=k>break</span><span class=p>;</span>
    <span class=k>case</span> <span class=p>(</span><span class=n>STATEMENT_SELECT</span><span class=p>)</span><span class=o>:</span>
      <span class=n>printf</span><span class=p>(</span><span class=s>&#34;This is where we would do a select.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
      <span class=k>break</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span></code></pre></div><p>Note that it doesn&rsquo;t return any error codes because there&rsquo;s nothing that could go wrong yet.</p><p>With these refactors, we now recognize two new keywords!</p><div class=highlight><pre class=chroma><code class=language-command-line data-lang=command-line>~ ./db
db &gt; insert foo bar
This is where we would do an insert.
Executed.
db &gt; delete foo
Unrecognized keyword at start of &#39;delete foo&#39;.
db &gt; select
This is where we would do a select.
Executed.
db &gt; .tables
Unrecognized command &#39;.tables&#39;
db &gt; .exit
~</code></pre></div><p>The skeleton of our database is taking shape&hellip; wouldn&rsquo;t it be nice if it stored data? In the next part, we&rsquo;ll implement <code>insert</code> and <code>select</code>, creating the world&rsquo;s worst data store. In the mean time, here&rsquo;s the final file form this part.</p><figure class=code><figcaption><h2>part2.c</h2></figcaption><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdbool.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=k>typedef</span> <span class=k>struct</span>
<span class=p>{</span>
  <span class=kt>char</span> <span class=o>*</span><span class=n>buffer</span><span class=p>;</span>
  <span class=n>size_t</span> <span class=n>buffer_length</span><span class=p>;</span>
  <span class=n>ssize_t</span> <span class=n>input_length</span><span class=p>;</span>
<span class=p>}</span> <span class=n>InputBuffer</span><span class=p>;</span>

<span class=k>typedef</span> <span class=k>enum</span>
<span class=p>{</span>
  <span class=n>META_COMMAND_SUCCESS</span><span class=p>,</span>
  <span class=n>META_COMMAND_UNRECOGNIZED_COMMAND</span>
<span class=p>}</span> <span class=n>MetaCommandResult</span><span class=p>;</span>

<span class=k>typedef</span> <span class=k>enum</span>
<span class=p>{</span>
  <span class=n>PREPARE_SUCCESS</span><span class=p>,</span>
  <span class=n>PREPARE_UNRECOGNIZED_STATEMENT</span>
<span class=p>}</span> <span class=n>PrepareResult</span><span class=p>;</span>

<span class=k>typedef</span> <span class=k>enum</span>
<span class=p>{</span>
  <span class=n>STATEMENT_INSERT</span><span class=p>,</span>
  <span class=n>STATEMENT_SELECT</span>
<span class=p>}</span> <span class=n>StatementType</span><span class=p>;</span>

<span class=k>typedef</span> <span class=k>struct</span>
<span class=p>{</span>
  <span class=n>StatementType</span> <span class=n>type</span><span class=p>;</span>
<span class=p>}</span> <span class=n>Statement</span><span class=p>;</span>

<span class=n>InputBuffer</span> <span class=o>*</span><span class=nf>new_input_buffer</span><span class=p>()</span>
<span class=p>{</span>
  <span class=n>InputBuffer</span> <span class=o>*</span><span class=n>input_buffer</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>InputBuffer</span><span class=p>));</span>
  <span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
  <span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer_length</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>input_length</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

  <span class=k>return</span> <span class=n>input_buffer</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>close_input_buffer</span><span class=p>(</span><span class=n>InputBuffer</span> <span class=o>*</span><span class=n>input_buffer</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>free</span><span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>);</span>
  <span class=n>free</span><span class=p>(</span><span class=n>input_buffer</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>MetaCommandResult</span> <span class=nf>do_meta_command</span><span class=p>(</span><span class=n>InputBuffer</span> <span class=o>*</span><span class=n>input_buffer</span><span class=p>)</span>
<span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>,</span> <span class=s>&#34;.exit&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=n>close_input_buffer</span><span class=p>(</span><span class=n>input_buffer</span><span class=p>);</span>
    <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_SUCCESS</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>else</span>
  <span class=p>{</span>
    <span class=k>return</span> <span class=n>META_COMMAND_UNRECOGNIZED_COMMAND</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=n>PrepareResult</span> <span class=nf>prepare_statement</span><span class=p>(</span><span class=n>InputBuffer</span> <span class=o>*</span><span class=n>input_buffer</span><span class=p>,</span>
                                <span class=n>Statement</span> <span class=o>*</span><span class=n>statement</span><span class=p>)</span>
<span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>strncmp</span><span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>,</span> <span class=s>&#34;insert&#34;</span><span class=p>,</span> <span class=mi>6</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=n>statement</span><span class=o>-&gt;</span><span class=n>type</span> <span class=o>=</span> <span class=n>STATEMENT_INSERT</span><span class=p>;</span>
    <span class=k>return</span> <span class=n>PREPARE_SUCCESS</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>,</span> <span class=s>&#34;select&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=n>statement</span><span class=o>-&gt;</span><span class=n>type</span> <span class=o>=</span> <span class=n>STATEMENT_SELECT</span><span class=p>;</span>
    <span class=k>return</span> <span class=n>PREPARE_SUCCESS</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=n>PREPARE_UNRECOGNIZED_STATEMENT</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>execute_statement</span><span class=p>(</span><span class=n>Statement</span> <span class=o>*</span><span class=n>statement</span><span class=p>)</span>
<span class=p>{</span>
  <span class=k>switch</span> <span class=p>(</span><span class=n>statement</span><span class=o>-&gt;</span><span class=n>type</span><span class=p>)</span>
  <span class=p>{</span>
  <span class=k>case</span> <span class=p>(</span><span class=n>STATEMENT_INSERT</span><span class=p>)</span><span class=o>:</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;This is where we would do an insert.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
    <span class=k>break</span><span class=p>;</span>
  <span class=k>case</span> <span class=p>(</span><span class=n>STATEMENT_SELECT</span><span class=p>)</span><span class=o>:</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;This is where we would do a select.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
    <span class=k>break</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>print_prompt</span><span class=p>()</span> <span class=p>{</span> <span class=n>printf</span><span class=p>(</span><span class=s>&#34;db &gt; &#34;</span><span class=p>);</span> <span class=p>}</span>

<span class=kt>void</span> <span class=nf>read_input</span><span class=p>(</span><span class=n>InputBuffer</span> <span class=o>*</span><span class=n>input_buffer</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>ssize_t</span> <span class=n>bytes_read</span> <span class=o>=</span>
      <span class=n>getline</span><span class=p>(</span><span class=o>&amp;</span><span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>),</span> <span class=o>&amp;</span><span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer_length</span><span class=p>),</span> <span class=n>stdin</span><span class=p>);</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>bytes_read</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Error reading input</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
    <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// Ignore trailing newline
</span><span class=c1></span>  <span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>input_length</span> <span class=o>=</span> <span class=n>bytes_read</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
  <span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>[</span><span class=n>bytes_read</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
<span class=p>{</span>
  <span class=n>InputBuffer</span> <span class=o>*</span><span class=n>input_buffer</span> <span class=o>=</span> <span class=n>new_input_buffer</span><span class=p>();</span>
  <span class=k>while</span> <span class=p>(</span><span class=nb>true</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=n>print_prompt</span><span class=p>();</span>
    <span class=n>read_input</span><span class=p>(</span><span class=n>input_buffer</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>,</span> <span class=s>&#34;.exit&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
    <span class=p>{</span>
      <span class=n>close_input_buffer</span><span class=p>(</span><span class=n>input_buffer</span><span class=p>);</span>
      <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_SUCCESS</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>else</span>
    <span class=p>{</span>
      <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Unrecognized command &#39;%s&#39;.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>);</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=sc>&#39;.&#39;</span><span class=p>)</span>
      <span class=p>{</span>
        <span class=k>switch</span> <span class=p>(</span><span class=n>do_meta_command</span><span class=p>(</span><span class=n>input_buffer</span><span class=p>))</span>
        <span class=p>{</span>
        <span class=k>case</span> <span class=p>(</span><span class=n>META_COMMAND_SUCCESS</span><span class=p>)</span><span class=o>:</span>
          <span class=k>continue</span><span class=p>;</span>
        <span class=k>case</span> <span class=p>(</span><span class=n>META_COMMAND_UNRECOGNIZED_COMMAND</span><span class=p>)</span><span class=o>:</span>
          <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Unrecognized command &#39;%s&#39;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>);</span>
          <span class=k>continue</span><span class=p>;</span>
        <span class=p>}</span>
      <span class=p>}</span>

      <span class=n>Statement</span> <span class=n>statement</span><span class=p>;</span>
      <span class=k>switch</span> <span class=p>(</span><span class=n>prepare_statement</span><span class=p>(</span><span class=n>input_buffer</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>statement</span><span class=p>))</span>
      <span class=p>{</span>
      <span class=k>case</span> <span class=p>(</span><span class=n>PREPARE_SUCCESS</span><span class=p>)</span><span class=o>:</span>
        <span class=k>break</span><span class=p>;</span>
      <span class=k>case</span> <span class=p>(</span><span class=n>PREPARE_UNRECOGNIZED_STATEMENT</span><span class=p>)</span><span class=o>:</span>
        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Unrecognized keyword at start of &#39;%s&#39;.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
               <span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>);</span>
        <span class=k>continue</span><span class=p>;</span>
      <span class=p>}</span>

      <span class=n>execute_statement</span><span class=p>(</span><span class=o>&amp;</span><span class=n>statement</span><span class=p>);</span>
      <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Executed.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span></code></pre></td></tr></table></div></div></figure><div class=edit-meta><br><a href=https://github.com/stanzheng/build-a-db/edit/master/content/using_c/part2.md class=edit-page><i class="fas fa-pen-square"></i>Edit on GitHub</a></div><nav class=pagination><a class="nav nav-prev" href=/using_c/part1/ title="Part 1 - Introduction and Setting up the REPL"><i class="fas fa-arrow-left" aria-hidden=true></i>Prev - Part 1 - Introduction and Setting up the REPL</a>
<a class="nav nav-next" href=/using_c/part3/ title="Part 3 - An In-Memory, Append-Only, Single-Table Database">Next - Part 3 - An In-Memory, Append-Only, Single-Table Database <i class="fas fa-arrow-right" aria-hidden=true></i></a></nav><footer><p class=powered>Powered by <a href=https://gohugo.io>Hugo</a>. Theme by <a href=https://themes.gohugo.io/hugo-theme-techdoc/>TechDoc</a>. Designed by <a href=https://github.com/thingsym/hugo-theme-techdoc>Thingsym</a>.</p></footer></main><div class=sidebar><nav class=open-menu><ul><li><a href=https://build-a-db.stanzheng.com/>Home</a></li><li class=parent><a href=/using_c/>How Does a Database Work? In [C]</a><ul class=sub-menu><li><a href=/using_c/part1/>Part 1 - Introduction and Setting up the REPL</a></li><li class=active><a href=/using_c/part2/>Part 2 - World&#39;s Simplest SQL Compiler and Virtual Machine</a></li><li><a href=/using_c/part3/>Part 3 - An In-Memory, Append-Only, Single-Table Database</a></li><li><a href=/using_c/part4/>Part 4 - Our First Tests (and Bugs)</a></li><li><a href=/using_c/part5/>Part 5 - Persistence to Disk</a></li><li><a href=/using_c/part6/>Part 6 - The Cursor Abstraction</a></li><li><a href=/using_c/part7/>Part 7 - Introduction to the B-Tree</a></li><li><a href=/using_c/part8/>Part 8 - B-Tree Leaf Node Format</a></li><li><a href=/using_c/part9/>Part 9 - Binary Search and Duplicate Keys</a></li><li><a href=/using_c/part10/>Part 10 - Splitting a Leaf Node</a></li><li><a href=/using_c/part11/>Part 11 - Recursively Searching the B-Tree</a></li><li><a href=/using_c/part12/>Part 12 - Scanning a Multi-Level B-Tree</a></li><li><a href=/using_c/part13/>Part 13 - Updating Parent Node After a Split</a></li></ul></li><li><a href=/using_python/>How Does a Database Work? In [Python]</a><ul class=sub-menu><li><a href=/using_python/part1/>Part 1 - Introduction and Setting up the REPL</a></li><li><a href=/using_python/part2/>Part 2 - World&#39;s Simplest SQL Compiler and Virtual Machine</a></li><li><a href=/using_python/part3/>Part 3 - An In-Memory, Append-Only, Single-Table Database</a></li><li><a href=/using_python/code/part4/>Part 4 - Our First Tests (and Bugs)</a></li></ul></li></ul></nav><div class=sidebar-footer></div></div></div><a href=# id=backtothetop-fixed class=backtothetop data-backtothetop-duration=600 data-backtothetop-easing=easeOutQuart data-backtothetop-fixed-fadein=1000 data-backtothetop-fixed-fadeout=1000 data-backtothetop-fixed-bottom=10 data-backtothetop-fixed-right=20><span class="fa-layers fa-fw"><i class="fas fa-circle"></i><i class="fas fa-arrow-circle-up"></i></span></a></div></body></html>
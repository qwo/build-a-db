<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Part 4 - Our First Tests (and Bugs) - Build a database in X</title><meta name=description content="Learn By Building"><meta name=generator content="Hugo 0.58.3"><link href=https://build-a-db.stanzheng.com/index.xml rel=alternate type=application/rss+xml><link rel=canonical href=https://build-a-db.stanzheng.com/using_c/part4/><link rel=stylesheet href=https://build-a-db.stanzheng.com/css/theme.min.css><script src=https://use.fontawesome.com/releases/v5.0.6/js/all.js></script><link rel=stylesheet href=https://build-a-db.stanzheng.com/css/chroma.min.css><script src=https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js></script><script src=https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js></script><script src=https://build-a-db.stanzheng.com/js/bundle.js></script><style>:root{}</style></head><body><div class=container><header><h1>Build a database in X</h1><span class=version>Version 1.0.0</span><p class=description>Learn By Building</p></header><div class=global-menu><nav><ul><li><a href=/>Home</a></li><li><a href=https://github.com/stanzheng/build-a-db>Github</a></li><li><a href=https://twitter.com/stanzheng>Twitter</a></li></ul></nav></div><div class=content-container><main><h1>Part 4 - Our First Tests (and Bugs)</h1><p>We&rsquo;ve got the ability to insert rows into our database and to print out all rows. Let&rsquo;s take a moment to test what we&rsquo;ve got so far.</p><p>I&rsquo;m going to use <a href=http://rspec.info/>rspec</a> to write my tests because I&rsquo;m familiar with it, and the syntax is fairly readable.</p><p>I&rsquo;ll define a short helper to send a list of commands to our database program then make assertions about the output:</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=n>describe</span> <span class=s1>&#39;database&#39;</span> <span class=k>do</span>
  <span class=k>def</span> <span class=nf>run_script</span><span class=p>(</span><span class=n>commands</span><span class=p>)</span>
    <span class=n>raw_output</span> <span class=o>=</span> <span class=kp>nil</span>
    <span class=no>IO</span><span class=o>.</span><span class=n>popen</span><span class=p>(</span><span class=s2>&#34;./db&#34;</span><span class=p>,</span> <span class=s2>&#34;r+&#34;</span><span class=p>)</span> <span class=k>do</span> <span class=o>|</span><span class=n>pipe</span><span class=o>|</span>
      <span class=n>commands</span><span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>command</span><span class=o>|</span>
        <span class=n>pipe</span><span class=o>.</span><span class=n>puts</span> <span class=n>command</span>
      <span class=k>end</span>

      <span class=n>pipe</span><span class=o>.</span><span class=n>close_write</span>

      <span class=c1># Read entire output</span>
      <span class=n>raw_output</span> <span class=o>=</span> <span class=n>pipe</span><span class=o>.</span><span class=n>gets</span><span class=p>(</span><span class=kp>nil</span><span class=p>)</span>
    <span class=k>end</span>
    <span class=n>raw_output</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
  <span class=k>end</span>

  <span class=n>it</span> <span class=s1>&#39;inserts and retreives a row&#39;</span> <span class=k>do</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>run_script</span><span class=p>(</span><span class=o>[</span>
      <span class=s2>&#34;insert 1 user1 person1@example.com&#34;</span><span class=p>,</span>
      <span class=s2>&#34;select&#34;</span><span class=p>,</span>
      <span class=s2>&#34;.exit&#34;</span><span class=p>,</span>
    <span class=o>]</span><span class=p>)</span>
    <span class=n>expect</span><span class=p>(</span><span class=n>result</span><span class=p>)</span><span class=o>.</span><span class=n>to</span> <span class=n>match_array</span><span class=p>(</span><span class=o>[</span>
      <span class=s2>&#34;db &gt; Executed.&#34;</span><span class=p>,</span>
      <span class=s2>&#34;db &gt; (1, user1, person1@example.com)&#34;</span><span class=p>,</span>
      <span class=s2>&#34;Executed.&#34;</span><span class=p>,</span>
      <span class=s2>&#34;db &gt; &#34;</span><span class=p>,</span>
    <span class=o>]</span><span class=p>)</span>
  <span class=k>end</span>
<span class=k>end</span></code></pre></div><p>This simple test makes sure we get back what we put in. And indeed it passes:</p><div class=highlight><pre class=chroma><code class=language-command-line data-lang=command-line>bundle exec rspec
.

Finished in 0.00871 seconds (files took 0.09506 seconds to load)
1 example, 0 failures</code></pre></div><p>Now it&rsquo;s feasible to test inserting a large number of rows into the database:</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=n>it</span> <span class=s1>&#39;prints error message when table is full&#39;</span> <span class=k>do</span>
  <span class=n>script</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span><span class=o>..</span><span class=mi>1401</span><span class=p>)</span><span class=o>.</span><span class=n>map</span> <span class=k>do</span> <span class=o>|</span><span class=n>i</span><span class=o>|</span>
    <span class=s2>&#34;insert </span><span class=si>#{</span><span class=n>i</span><span class=si>}</span><span class=s2> user</span><span class=si>#{</span><span class=n>i</span><span class=si>}</span><span class=s2> person</span><span class=si>#{</span><span class=n>i</span><span class=si>}</span><span class=s2>@example.com&#34;</span>
  <span class=k>end</span>
  <span class=n>script</span> <span class=o>&lt;&lt;</span> <span class=s2>&#34;.exit&#34;</span>
  <span class=n>result</span> <span class=o>=</span> <span class=n>run_script</span><span class=p>(</span><span class=n>script</span><span class=p>)</span>
  <span class=n>expect</span><span class=p>(</span><span class=n>result</span><span class=o>[-</span><span class=mi>2</span><span class=o>]</span><span class=p>)</span><span class=o>.</span><span class=n>to</span> <span class=n>eq</span><span class=p>(</span><span class=s1>&#39;db &gt; Error: Table full.&#39;</span><span class=p>)</span>
<span class=k>end</span></code></pre></div><p>Running tests again&hellip;</p><div class=highlight><pre class=chroma><code class=language-command-line data-lang=command-line>bundle exec rspec
..

Finished in 0.01553 seconds (files took 0.08156 seconds to load)
2 examples, 0 failures</code></pre></div><p>Sweet, it works! Our db can hold 1400 rows right now because we set the maximum number of pages to 100, and 14 rows can fit in a page.</p><p>Reading through the code we have so far, I realized we might not handle storing text fields correctly. Easy to test with this example:</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=n>it</span> <span class=s1>&#39;allows inserting strings that are the maximum length&#39;</span> <span class=k>do</span>
  <span class=n>long_username</span> <span class=o>=</span> <span class=s2>&#34;a&#34;</span><span class=o>*</span><span class=mi>32</span>
  <span class=n>long_email</span> <span class=o>=</span> <span class=s2>&#34;a&#34;</span><span class=o>*</span><span class=mi>255</span>
  <span class=n>script</span> <span class=o>=</span> <span class=o>[</span>
    <span class=s2>&#34;insert 1 </span><span class=si>#{</span><span class=n>long_username</span><span class=si>}</span><span class=s2> </span><span class=si>#{</span><span class=n>long_email</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
    <span class=s2>&#34;select&#34;</span><span class=p>,</span>
    <span class=s2>&#34;.exit&#34;</span><span class=p>,</span>
  <span class=o>]</span>
  <span class=n>result</span> <span class=o>=</span> <span class=n>run_script</span><span class=p>(</span><span class=n>script</span><span class=p>)</span>
  <span class=n>expect</span><span class=p>(</span><span class=n>result</span><span class=p>)</span><span class=o>.</span><span class=n>to</span> <span class=n>match_array</span><span class=p>(</span><span class=o>[</span>
    <span class=s2>&#34;db &gt; Executed.&#34;</span><span class=p>,</span>
    <span class=s2>&#34;db &gt; (1, </span><span class=si>#{</span><span class=n>long_username</span><span class=si>}</span><span class=s2>, </span><span class=si>#{</span><span class=n>long_email</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>,</span>
    <span class=s2>&#34;Executed.&#34;</span><span class=p>,</span>
    <span class=s2>&#34;db &gt; &#34;</span><span class=p>,</span>
  <span class=o>]</span><span class=p>)</span>
<span class=k>end</span></code></pre></div><p>And the test fails!</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=ss>Failures</span><span class=p>:</span>

  <span class=mi>1</span><span class=p>)</span> <span class=n>database</span> <span class=n>allows</span> <span class=n>inserting</span> <span class=n>strings</span> <span class=n>that</span> <span class=n>are</span> <span class=n>the</span> <span class=n>maximum</span> <span class=n>length</span>
     <span class=no>Failure</span><span class=o>/</span><span class=ss>Error</span><span class=p>:</span> <span class=n>raw_output</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>

     <span class=ss>ArgumentError</span><span class=p>:</span>
       <span class=n>invalid</span> <span class=n>byte</span> <span class=n>sequence</span> <span class=k>in</span> <span class=no>UTF</span><span class=o>-</span><span class=mi>8</span>
     <span class=c1># ./spec/main_spec.rb:14:in `split&#39;</span>
     <span class=c1># ./spec/main_spec.rb:14:in `run_script&#39;</span>
     <span class=c1># ./spec/main_spec.rb:48:in `block (2 levels) in &lt;top (required)&gt;&#39;</span></code></pre></div><p>If we try it ourselves, we&rsquo;ll see that there&rsquo;s some weird characters when we try to print out the row. (I&rsquo;m abbreviating the long strings):</p><div class=highlight><pre class=chroma><code class=language-command-line data-lang=command-line>db &gt; insert 1 aaaaa... aaaaa...
Executed.
db &gt; select
(1, aaaaa...aaa\�, aaaaa...aaa\�)
Executed.
db &gt;</code></pre></div><p>What&rsquo;s going on? If you take a look at our definition of a Row, we allocate exactly 32 bytes for username and exactly 255 bytes for email. But <a href=http://www.cprogramming.com/tutorial/c/lesson9.html>C strings</a> are supposed to end with a null character, which we didn&rsquo;t allocate space for. The solution is to allocate one additional byte:</p><div class=highlight><pre class=chroma><code class=language-diff data-lang=diff> const uint32_t COLUMN_EMAIL_SIZE = 255;
 typedef struct {
   uint32_t id;
<span class=gd>-  char username[COLUMN_USERNAME_SIZE];
</span><span class=gd>-  char email[COLUMN_EMAIL_SIZE];
</span><span class=gd></span><span class=gi>+  char username[COLUMN_USERNAME_SIZE + 1];
</span><span class=gi>+  char email[COLUMN_EMAIL_SIZE + 1];
</span><span class=gi></span> } Row;
</code></pre></div><p>And indeed that fixes it:</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby> <span class=n>bundle</span> <span class=nb>exec</span> <span class=n>rspec</span>
<span class=o>...</span>

<span class=no>Finished</span> <span class=k>in</span> <span class=mi>0</span><span class=o>.</span><span class=mo>01</span><span class=mi>88</span> <span class=n>seconds</span> <span class=p>(</span><span class=n>files</span> <span class=n>took</span> <span class=mi>0</span><span class=o>.</span><span class=mi>08516</span> <span class=n>seconds</span> <span class=n>to</span> <span class=nb>load</span><span class=p>)</span>
<span class=mi>3</span> <span class=n>examples</span><span class=p>,</span> <span class=mi>0</span> <span class=n>failures</span></code></pre></div><p>We should not allow inserting usernames or emails that are longer than column size. The spec for that looks like this:</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=n>it</span> <span class=s1>&#39;prints error message if strings are too long&#39;</span> <span class=k>do</span>
  <span class=n>long_username</span> <span class=o>=</span> <span class=s2>&#34;a&#34;</span><span class=o>*</span><span class=mi>33</span>
  <span class=n>long_email</span> <span class=o>=</span> <span class=s2>&#34;a&#34;</span><span class=o>*</span><span class=mi>256</span>
  <span class=n>script</span> <span class=o>=</span> <span class=o>[</span>
    <span class=s2>&#34;insert 1 </span><span class=si>#{</span><span class=n>long_username</span><span class=si>}</span><span class=s2> </span><span class=si>#{</span><span class=n>long_email</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
    <span class=s2>&#34;select&#34;</span><span class=p>,</span>
    <span class=s2>&#34;.exit&#34;</span><span class=p>,</span>
  <span class=o>]</span>
  <span class=n>result</span> <span class=o>=</span> <span class=n>run_script</span><span class=p>(</span><span class=n>script</span><span class=p>)</span>
  <span class=n>expect</span><span class=p>(</span><span class=n>result</span><span class=p>)</span><span class=o>.</span><span class=n>to</span> <span class=n>match_array</span><span class=p>(</span><span class=o>[</span>
    <span class=s2>&#34;db &gt; String is too long.&#34;</span><span class=p>,</span>
    <span class=s2>&#34;db &gt; Executed.&#34;</span><span class=p>,</span>
    <span class=s2>&#34;db &gt; &#34;</span><span class=p>,</span>
  <span class=o>]</span><span class=p>)</span>
<span class=k>end</span></code></pre></div><p>In order to do this we need to upgrade our parser. As a reminder, we&rsquo;re currently using <a href=https://linux.die.net/man/3/scanf>scanf()</a>:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>if</span> <span class=p>(</span><span class=n>strncmp</span><span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>,</span> <span class=s>&#34;insert&#34;</span><span class=p>,</span> <span class=mi>6</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>statement</span><span class=o>-&gt;</span><span class=n>type</span> <span class=o>=</span> <span class=n>STATEMENT_INSERT</span><span class=p>;</span>
  <span class=kt>int</span> <span class=n>args_assigned</span> <span class=o>=</span> <span class=n>sscanf</span><span class=p>(</span>
      <span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>,</span> <span class=s>&#34;insert %d %s %s&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=p>(</span><span class=n>statement</span><span class=o>-&gt;</span><span class=n>row_to_insert</span><span class=p>.</span><span class=n>id</span><span class=p>),</span>
      <span class=n>statement</span><span class=o>-&gt;</span><span class=n>row_to_insert</span><span class=p>.</span><span class=n>username</span><span class=p>,</span> <span class=n>statement</span><span class=o>-&gt;</span><span class=n>row_to_insert</span><span class=p>.</span><span class=n>email</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>args_assigned</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>PREPARE_SYNTAX_ERROR</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>PREPARE_SUCCESS</span><span class=p>;</span>
<span class=p>}</span></code></pre></div><p>But <a href=https://stackoverflow.com/questions/2430303/disadvantages-of-scanf>scanf has some disadvantages</a>. If the string it&rsquo;s reading is larger than the buffer it&rsquo;s reading into, it will cause a buffer overflow and start writing into unexpected places. We want to check the length of each string before we copy it into a <code>Row</code> structure. And to do that, we need to divide the input by spaces.</p><p>I&rsquo;m going to use <a href=http://www.cplusplus.com/reference/cstring/strtok/>strtok()</a> to do that. I think it&rsquo;s easiest to understand if you see it in action:</p><div class=highlight><pre class=chroma><code class=language-diff data-lang=diff><span class=gi>+PrepareResult prepare_insert(InputBuffer* input_buffer, Statement* statement) {
</span><span class=gi>+  statement-&gt;type = STATEMENT_INSERT;
</span><span class=gi>+
</span><span class=gi>+  char* keyword = strtok(input_buffer-&gt;buffer, &#34; &#34;);
</span><span class=gi>+  char* id_string = strtok(NULL, &#34; &#34;);
</span><span class=gi>+  char* username = strtok(NULL, &#34; &#34;);
</span><span class=gi>+  char* email = strtok(NULL, &#34; &#34;);
</span><span class=gi>+
</span><span class=gi>+  if (id_string == NULL || username == NULL || email == NULL) {
</span><span class=gi>+    return PREPARE_SYNTAX_ERROR;
</span><span class=gi>+  }
</span><span class=gi>+
</span><span class=gi>+  int id = atoi(id_string);
</span><span class=gi>+  if (strlen(username) &gt; COLUMN_USERNAME_SIZE) {
</span><span class=gi>+    return PREPARE_STRING_TOO_LONG;
</span><span class=gi>+  }
</span><span class=gi>+  if (strlen(email) &gt; COLUMN_EMAIL_SIZE) {
</span><span class=gi>+    return PREPARE_STRING_TOO_LONG;
</span><span class=gi>+  }
</span><span class=gi>+
</span><span class=gi>+  statement-&gt;row_to_insert.id = id;
</span><span class=gi>+  strcpy(statement-&gt;row_to_insert.username, username);
</span><span class=gi>+  strcpy(statement-&gt;row_to_insert.email, email);
</span><span class=gi>+
</span><span class=gi>+  return PREPARE_SUCCESS;
</span><span class=gi>+}
</span><span class=gi>+
</span><span class=gi></span> PrepareResult prepare_statement(InputBuffer* input_buffer,
                                 Statement* statement) {
   if (strncmp(input_buffer-&gt;buffer, &#34;insert&#34;, 6) == 0) {
<span class=gi>+    return prepare_insert(input_buffer, statement);
</span><span class=gi></span><span class=gd>-    statement-&gt;type = STATEMENT_INSERT;
</span><span class=gd>-    int args_assigned = sscanf(
</span><span class=gd>-        input_buffer-&gt;buffer, &#34;insert %d %s %s&#34;, &amp;(statement-&gt;row_to_insert.id),
</span><span class=gd>-        statement-&gt;row_to_insert.username, statement-&gt;row_to_insert.email);
</span><span class=gd>-    if (args_assigned &lt; 3) {
</span><span class=gd>-      return PREPARE_SYNTAX_ERROR;
</span><span class=gd>-    }
</span><span class=gd>-    return PREPARE_SUCCESS;
</span><span class=gd></span>   }
</code></pre></div><p>Calling <code>strtok</code> successively on the the input buffer breaks it into substrings by inserting a null character whenever it reaches a delimiter (space, in our case). It returns a pointer to the start of the substring.</p><p>We can call <a href=http://www.cplusplus.com/reference/cstring/strlen/>strlen()</a> on each text value to see if it&rsquo;s too long.</p><p>We can handle the error like we do any other error code:</p><div class=highlight><pre class=chroma><code class=language-diff data-lang=diff> enum PrepareResult_t {
   PREPARE_SUCCESS,
<span class=gi>+  PREPARE_STRING_TOO_LONG,
</span><span class=gi></span>   PREPARE_SYNTAX_ERROR,
   PREPARE_UNRECOGNIZED_STATEMENT
 };
</code></pre></div><div class=highlight><pre class=chroma><code class=language-diff data-lang=diff> switch (prepare_statement(input_buffer, &amp;statement)) {
   case (PREPARE_SUCCESS):
     break;
<span class=gi>+  case (PREPARE_STRING_TOO_LONG):
</span><span class=gi>+    printf(&#34;String is too long.\n&#34;);
</span><span class=gi>+    continue;
</span><span class=gi></span>   case (PREPARE_SYNTAX_ERROR):
     printf(&#34;Syntax error. Could not parse statement.\n&#34;);
     continue;
</code></pre></div><p>Which makes our test pass</p><div class=highlight><pre class=chroma><code class=language-command-line data-lang=command-line>bundle exec rspec
....

Finished in 0.02284 seconds (files took 0.116 seconds to load)
4 examples, 0 failures</code></pre></div><p>While we&rsquo;re here, we might as well handle one more error case:</p><div class=highlight><pre class=chroma><code class=language-ruby data-lang=ruby><span class=n>it</span> <span class=s1>&#39;prints an error message if id is negative&#39;</span> <span class=k>do</span>
  <span class=n>script</span> <span class=o>=</span> <span class=o>[</span>
    <span class=s2>&#34;insert -1 cstack foo@bar.com&#34;</span><span class=p>,</span>
    <span class=s2>&#34;select&#34;</span><span class=p>,</span>
    <span class=s2>&#34;.exit&#34;</span><span class=p>,</span>
  <span class=o>]</span>
  <span class=n>result</span> <span class=o>=</span> <span class=n>run_script</span><span class=p>(</span><span class=n>script</span><span class=p>)</span>
  <span class=n>expect</span><span class=p>(</span><span class=n>result</span><span class=p>)</span><span class=o>.</span><span class=n>to</span> <span class=n>match_array</span><span class=p>(</span><span class=o>[</span>
    <span class=s2>&#34;db &gt; ID must be positive.&#34;</span><span class=p>,</span>
    <span class=s2>&#34;db &gt; Executed.&#34;</span><span class=p>,</span>
    <span class=s2>&#34;db &gt; &#34;</span><span class=p>,</span>
  <span class=o>]</span><span class=p>)</span>
<span class=k>end</span></code></pre></div><div class=highlight><pre class=chroma><code class=language-diff data-lang=diff> enum PrepareResult_t {
   PREPARE_SUCCESS,
<span class=gi>+  PREPARE_NEGATIVE_ID,
</span><span class=gi></span>   PREPARE_STRING_TOO_LONG,
   PREPARE_SYNTAX_ERROR,
   PREPARE_UNRECOGNIZED_STATEMENT
<span class=gu>@@ -148,9 +147,6 @@ PrepareResult prepare_insert(InputBuffer* input_buffer, Statement* statement) {
</span><span class=gu></span>   }

   int id = atoi(id_string);
<span class=gi>+  if (id &lt; 0) {
</span><span class=gi>+    return PREPARE_NEGATIVE_ID;
</span><span class=gi>+  }
</span><span class=gi></span>   if (strlen(username) &gt; COLUMN_USERNAME_SIZE) {
     return PREPARE_STRING_TOO_LONG;
   }
<span class=gu>@@ -230,9 +226,6 @@ int main(int argc, char* argv[]) {
</span><span class=gu></span>     switch (prepare_statement(input_buffer, &amp;statement)) {
       case (PREPARE_SUCCESS):
         break;
<span class=gi>+      case (PREPARE_NEGATIVE_ID):
</span><span class=gi>+        printf(&#34;ID must be positive.\n&#34;);
</span><span class=gi>+        continue;
</span><span class=gi></span>       case (PREPARE_STRING_TOO_LONG):
         printf(&#34;String is too long.\n&#34;);
         continue;
</code></pre></div><p>Alright, that&rsquo;s enough testing for now. Next is a very important feature: persistence! We&rsquo;re going to save our database to a file and read it back out again.</p><p>It&rsquo;s gonna be great.</p><p>Here&rsquo;s the complete c code for this part:</p><figure class=code><figcaption><h2>part4.c</h2></figcaption><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span><span class=lnt>296
</span><span class=lnt>297
</span><span class=lnt>298
</span><span class=lnt>299
</span><span class=lnt>300
</span><span class=lnt>301
</span><span class=lnt>302
</span><span class=lnt>303
</span><span class=lnt>304
</span><span class=lnt>305
</span><span class=lnt>306
</span><span class=lnt>307
</span><span class=lnt>308
</span><span class=lnt>309
</span><span class=lnt>310
</span><span class=lnt>311
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-c data-lang=c><span class=cp>#include</span> <span class=cpf>&lt;stdbool.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&lt;stdint.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=k>typedef</span> <span class=k>struct</span>
<span class=p>{</span>
  <span class=kt>char</span> <span class=o>*</span><span class=n>buffer</span><span class=p>;</span>
  <span class=n>size_t</span> <span class=n>buffer_length</span><span class=p>;</span>
  <span class=n>ssize_t</span> <span class=n>input_length</span><span class=p>;</span>
<span class=p>}</span> <span class=n>InputBuffer</span><span class=p>;</span>

<span class=k>typedef</span> <span class=k>enum</span>
<span class=p>{</span>
  <span class=n>EXECUTE_SUCCESS</span><span class=p>,</span>
  <span class=n>EXECUTE_TABLE_FULL</span>
<span class=p>}</span> <span class=n>ExecuteResult</span><span class=p>;</span>

<span class=k>typedef</span> <span class=k>enum</span>
<span class=p>{</span>
  <span class=n>META_COMMAND_SUCCESS</span><span class=p>,</span>
  <span class=n>META_COMMAND_UNRECOGNIZED_COMMAND</span>
<span class=p>}</span> <span class=n>MetaCommandResult</span><span class=p>;</span>

<span class=k>typedef</span> <span class=k>enum</span>
<span class=p>{</span>
  <span class=n>PREPARE_SUCCESS</span><span class=p>,</span>
  <span class=n>PREPARE_SYNTAX_ERROR</span><span class=p>,</span>
  <span class=n>PREPARE_NEGATIVE_ID</span><span class=p>,</span>
  <span class=n>PREPARE_STRING_TOO_LONG</span><span class=p>,</span>
  <span class=n>PREPARE_UNRECOGNIZED_STATEMENT</span>
<span class=p>}</span> <span class=n>PrepareResult</span><span class=p>;</span>

<span class=k>typedef</span> <span class=k>enum</span>
<span class=p>{</span>
  <span class=n>STATEMENT_INSERT</span><span class=p>,</span>
  <span class=n>STATEMENT_SELECT</span>
<span class=p>}</span> <span class=n>StatementType</span><span class=p>;</span>

<span class=cp>#define COLUMN_USERNAME_SIZE 32
</span><span class=cp>#define COLUMN_EMAIL_SIZE 255
</span><span class=cp></span><span class=k>typedef</span> <span class=k>struct</span>
<span class=p>{</span>
  <span class=n>uint32_t</span> <span class=n>id</span><span class=p>;</span>
  <span class=kt>char</span> <span class=n>username</span><span class=p>[</span><span class=n>COLUMN_USERNAME_SIZE</span> <span class=o>+</span> <span class=mi>1</span><span class=p>];</span>
  <span class=kt>char</span> <span class=n>email</span><span class=p>[</span><span class=n>COLUMN_EMAIL_SIZE</span> <span class=o>+</span> <span class=mi>1</span><span class=p>];</span>
<span class=p>}</span> <span class=n>Row</span><span class=p>;</span>

<span class=k>typedef</span> <span class=k>struct</span>
<span class=p>{</span>
  <span class=n>StatementType</span> <span class=n>type</span><span class=p>;</span>
  <span class=n>Row</span> <span class=n>row_to_insert</span><span class=p>;</span> <span class=c1>//only used by insert statement
</span><span class=c1></span><span class=p>}</span> <span class=n>Statement</span><span class=p>;</span>

<span class=cp>#define size_of_attribute(Struct, Attribute) sizeof(((Struct *)0)-&gt;Attribute)
</span><span class=cp></span>
<span class=k>const</span> <span class=n>uint32_t</span> <span class=n>ID_SIZE</span> <span class=o>=</span> <span class=n>size_of_attribute</span><span class=p>(</span><span class=n>Row</span><span class=p>,</span> <span class=n>id</span><span class=p>);</span>
<span class=k>const</span> <span class=n>uint32_t</span> <span class=n>USERNAME_SIZE</span> <span class=o>=</span> <span class=n>size_of_attribute</span><span class=p>(</span><span class=n>Row</span><span class=p>,</span> <span class=n>username</span><span class=p>);</span>
<span class=k>const</span> <span class=n>uint32_t</span> <span class=n>EMAIL_SIZE</span> <span class=o>=</span> <span class=n>size_of_attribute</span><span class=p>(</span><span class=n>Row</span><span class=p>,</span> <span class=n>email</span><span class=p>);</span>
<span class=k>const</span> <span class=n>uint32_t</span> <span class=n>ID_OFFSET</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<span class=k>const</span> <span class=n>uint32_t</span> <span class=n>USERNAME_OFFSET</span> <span class=o>=</span> <span class=n>ID_OFFSET</span> <span class=o>+</span> <span class=n>ID_SIZE</span><span class=p>;</span>
<span class=k>const</span> <span class=n>uint32_t</span> <span class=n>EMAIL_OFFSET</span> <span class=o>=</span> <span class=n>USERNAME_OFFSET</span> <span class=o>+</span> <span class=n>USERNAME_SIZE</span><span class=p>;</span>
<span class=k>const</span> <span class=n>uint32_t</span> <span class=n>ROW_SIZE</span> <span class=o>=</span> <span class=n>ID_SIZE</span> <span class=o>+</span> <span class=n>USERNAME_SIZE</span> <span class=o>+</span> <span class=n>EMAIL_SIZE</span><span class=p>;</span>

<span class=k>const</span> <span class=n>uint32_t</span> <span class=n>PAGE_SIZE</span> <span class=o>=</span> <span class=mi>4096</span><span class=p>;</span>
<span class=cp>#define TABLE_MAX_PAGES 100
</span><span class=cp></span><span class=k>const</span> <span class=n>uint32_t</span> <span class=n>ROWS_PER_PAGE</span> <span class=o>=</span> <span class=n>PAGE_SIZE</span> <span class=o>/</span> <span class=n>ROW_SIZE</span><span class=p>;</span>
<span class=k>const</span> <span class=n>uint32_t</span> <span class=n>TABLE_MAX_ROWS</span> <span class=o>=</span> <span class=n>ROWS_PER_PAGE</span> <span class=o>*</span> <span class=n>TABLE_MAX_PAGES</span><span class=p>;</span>

<span class=k>typedef</span> <span class=k>struct</span>
<span class=p>{</span>
  <span class=n>uint32_t</span> <span class=n>num_rows</span><span class=p>;</span>
  <span class=kt>void</span> <span class=o>*</span><span class=n>pages</span><span class=p>[</span><span class=n>TABLE_MAX_PAGES</span><span class=p>];</span>
<span class=p>}</span> <span class=n>Table</span><span class=p>;</span>

<span class=kt>void</span> <span class=nf>print_row</span><span class=p>(</span><span class=n>Row</span> <span class=o>*</span><span class=n>row</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>printf</span><span class=p>(</span><span class=s>&#34;(%d, %s, %s)</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>row</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>,</span> <span class=n>row</span><span class=o>-&gt;</span><span class=n>username</span><span class=p>,</span> <span class=n>row</span><span class=o>-&gt;</span><span class=n>email</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>serialize_row</span><span class=p>(</span><span class=n>Row</span> <span class=o>*</span><span class=n>source</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>destination</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>memcpy</span><span class=p>(</span><span class=n>destination</span> <span class=o>+</span> <span class=n>ID_OFFSET</span><span class=p>,</span> <span class=o>&amp;</span><span class=p>(</span><span class=n>source</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>),</span> <span class=n>ID_SIZE</span><span class=p>);</span>
  <span class=n>memcpy</span><span class=p>(</span><span class=n>destination</span> <span class=o>+</span> <span class=n>USERNAME_OFFSET</span><span class=p>,</span> <span class=o>&amp;</span><span class=p>(</span><span class=n>source</span><span class=o>-&gt;</span><span class=n>username</span><span class=p>),</span> <span class=n>USERNAME_SIZE</span><span class=p>);</span>
  <span class=n>memcpy</span><span class=p>(</span><span class=n>destination</span> <span class=o>+</span> <span class=n>EMAIL_OFFSET</span><span class=p>,</span> <span class=o>&amp;</span><span class=p>(</span><span class=n>source</span><span class=o>-&gt;</span><span class=n>email</span><span class=p>),</span> <span class=n>EMAIL_SIZE</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>deserialize_row</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>source</span><span class=p>,</span> <span class=n>Row</span> <span class=o>*</span><span class=n>destination</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>memcpy</span><span class=p>(</span><span class=o>&amp;</span><span class=p>(</span><span class=n>destination</span><span class=o>-&gt;</span><span class=n>id</span><span class=p>),</span> <span class=n>source</span> <span class=o>+</span> <span class=n>ID_OFFSET</span><span class=p>,</span> <span class=n>ID_SIZE</span><span class=p>);</span>
  <span class=n>memcpy</span><span class=p>(</span><span class=o>&amp;</span><span class=p>(</span><span class=n>destination</span><span class=o>-&gt;</span><span class=n>username</span><span class=p>),</span> <span class=n>source</span> <span class=o>+</span> <span class=n>USERNAME_OFFSET</span><span class=p>,</span> <span class=n>USERNAME_SIZE</span><span class=p>);</span>
  <span class=n>memcpy</span><span class=p>(</span><span class=o>&amp;</span><span class=p>(</span><span class=n>destination</span><span class=o>-&gt;</span><span class=n>email</span><span class=p>),</span> <span class=n>source</span> <span class=o>+</span> <span class=n>EMAIL_OFFSET</span><span class=p>,</span> <span class=n>EMAIL_SIZE</span><span class=p>);</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=o>*</span><span class=nf>row_slot</span><span class=p>(</span><span class=n>Table</span> <span class=o>*</span><span class=n>table</span><span class=p>,</span> <span class=n>uint32_t</span> <span class=n>row_num</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>uint32_t</span> <span class=n>page_num</span> <span class=o>=</span> <span class=n>row_num</span> <span class=o>/</span> <span class=n>ROWS_PER_PAGE</span><span class=p>;</span>
  <span class=kt>void</span> <span class=o>*</span><span class=n>page</span> <span class=o>=</span> <span class=n>table</span><span class=o>-&gt;</span><span class=n>pages</span><span class=p>[</span><span class=n>page_num</span><span class=p>];</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>page</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=c1>// Allocate memory only when we try to access page
</span><span class=c1></span>    <span class=n>page</span> <span class=o>=</span> <span class=n>table</span><span class=o>-&gt;</span><span class=n>pages</span><span class=p>[</span><span class=n>page_num</span><span class=p>]</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=n>PAGE_SIZE</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=n>uint32_t</span> <span class=n>row_offset</span> <span class=o>=</span> <span class=n>row_num</span> <span class=o>%</span> <span class=n>ROWS_PER_PAGE</span><span class=p>;</span>
  <span class=n>uint32_t</span> <span class=n>byte_offset</span> <span class=o>=</span> <span class=n>row_offset</span> <span class=o>*</span> <span class=n>ROW_SIZE</span><span class=p>;</span>
  <span class=k>return</span> <span class=n>page</span> <span class=o>+</span> <span class=n>byte_offset</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>Table</span> <span class=o>*</span><span class=nf>new_table</span><span class=p>()</span>
<span class=p>{</span>
  <span class=n>Table</span> <span class=o>*</span><span class=n>table</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>Table</span><span class=p>));</span>
  <span class=n>table</span><span class=o>-&gt;</span><span class=n>num_rows</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=k>for</span> <span class=p>(</span><span class=n>uint32_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>TABLE_MAX_PAGES</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=n>table</span><span class=o>-&gt;</span><span class=n>pages</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>table</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>free_table</span><span class=p>(</span><span class=n>Table</span> <span class=o>*</span><span class=n>table</span><span class=p>)</span>
<span class=p>{</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>table</span><span class=o>-&gt;</span><span class=n>pages</span><span class=p>[</span><span class=n>i</span><span class=p>];</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=n>free</span><span class=p>(</span><span class=n>table</span><span class=o>-&gt;</span><span class=n>pages</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
  <span class=p>}</span>
  <span class=n>free</span><span class=p>(</span><span class=n>table</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>InputBuffer</span> <span class=o>*</span><span class=nf>new_input_buffer</span><span class=p>()</span>
<span class=p>{</span>
  <span class=n>InputBuffer</span> <span class=o>*</span><span class=n>input_buffer</span> <span class=o>=</span> <span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>InputBuffer</span><span class=p>));</span>
  <span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
  <span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer_length</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>input_length</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

  <span class=k>return</span> <span class=n>input_buffer</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>close_input_buffer</span><span class=p>(</span><span class=n>InputBuffer</span> <span class=o>*</span><span class=n>input_buffer</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>free</span><span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>);</span>
  <span class=n>free</span><span class=p>(</span><span class=n>input_buffer</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>MetaCommandResult</span> <span class=nf>do_meta_command</span><span class=p>(</span><span class=n>InputBuffer</span> <span class=o>*</span><span class=n>input_buffer</span><span class=p>,</span> <span class=n>Table</span> <span class=o>*</span><span class=n>table</span><span class=p>)</span>
<span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>,</span> <span class=s>&#34;.exit&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=n>close_input_buffer</span><span class=p>(</span><span class=n>input_buffer</span><span class=p>);</span>
    <span class=n>free_table</span><span class=p>(</span><span class=n>table</span><span class=p>);</span>
    <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_SUCCESS</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>else</span>
  <span class=p>{</span>
    <span class=k>return</span> <span class=n>META_COMMAND_UNRECOGNIZED_COMMAND</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=n>PrepareResult</span> <span class=nf>prepare_insert</span><span class=p>(</span><span class=n>InputBuffer</span><span class=o>*</span> <span class=n>input_buffer</span><span class=p>,</span> <span class=n>Statement</span><span class=o>*</span> <span class=n>statement</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>statement</span><span class=o>-&gt;</span><span class=n>type</span> <span class=o>=</span> <span class=n>STATEMENT_INSERT</span><span class=p>;</span>

  <span class=kt>char</span><span class=o>*</span> <span class=n>keyword</span> <span class=o>=</span> <span class=n>strtok</span><span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>,</span> <span class=s>&#34; &#34;</span><span class=p>);</span>
  <span class=kt>char</span><span class=o>*</span> <span class=n>id_string</span> <span class=o>=</span> <span class=n>strtok</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=s>&#34; &#34;</span><span class=p>);</span>
  <span class=kt>char</span><span class=o>*</span> <span class=n>username</span> <span class=o>=</span> <span class=n>strtok</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=s>&#34; &#34;</span><span class=p>);</span>
  <span class=kt>char</span><span class=o>*</span> <span class=n>email</span> <span class=o>=</span> <span class=n>strtok</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=s>&#34; &#34;</span><span class=p>);</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>id_string</span> <span class=o>==</span> <span class=nb>NULL</span> <span class=o>||</span> <span class=n>username</span> <span class=o>==</span> <span class=nb>NULL</span> <span class=o>||</span> <span class=n>email</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>PREPARE_SYNTAX_ERROR</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=kt>int</span> <span class=n>id</span> <span class=o>=</span> <span class=n>atoi</span><span class=p>(</span><span class=n>id_string</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>id</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>PREPARE_NEGATIVE_ID</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>strlen</span><span class=p>(</span><span class=n>username</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>COLUMN_USERNAME_SIZE</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>PREPARE_STRING_TOO_LONG</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>strlen</span><span class=p>(</span><span class=n>email</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>COLUMN_EMAIL_SIZE</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>PREPARE_STRING_TOO_LONG</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>statement</span><span class=o>-&gt;</span><span class=n>row_to_insert</span><span class=p>.</span><span class=n>id</span> <span class=o>=</span> <span class=n>id</span><span class=p>;</span>
  <span class=n>strcpy</span><span class=p>(</span><span class=n>statement</span><span class=o>-&gt;</span><span class=n>row_to_insert</span><span class=p>.</span><span class=n>username</span><span class=p>,</span> <span class=n>username</span><span class=p>);</span>
  <span class=n>strcpy</span><span class=p>(</span><span class=n>statement</span><span class=o>-&gt;</span><span class=n>row_to_insert</span><span class=p>.</span><span class=n>email</span><span class=p>,</span> <span class=n>email</span><span class=p>);</span>

  <span class=k>return</span> <span class=n>PREPARE_SUCCESS</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>PrepareResult</span> <span class=nf>prepare_statement</span><span class=p>(</span><span class=n>InputBuffer</span><span class=o>*</span> <span class=n>input_buffer</span><span class=p>,</span>
                                <span class=n>Statement</span><span class=o>*</span> <span class=n>statement</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>strncmp</span><span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>,</span> <span class=s>&#34;insert&#34;</span><span class=p>,</span> <span class=mi>6</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>prepare_insert</span><span class=p>(</span><span class=n>input_buffer</span><span class=p>,</span> <span class=n>statement</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>,</span> <span class=s>&#34;select&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>statement</span><span class=o>-&gt;</span><span class=n>type</span> <span class=o>=</span> <span class=n>STATEMENT_SELECT</span><span class=p>;</span>
    <span class=k>return</span> <span class=n>PREPARE_SUCCESS</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=n>PREPARE_UNRECOGNIZED_STATEMENT</span><span class=p>;</span>
<span class=p>}</span>



<span class=n>ExecuteResult</span> <span class=nf>execute_insert</span><span class=p>(</span><span class=n>Statement</span> <span class=o>*</span><span class=n>statement</span><span class=p>,</span> <span class=n>Table</span> <span class=o>*</span><span class=n>table</span><span class=p>)</span>
<span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>table</span><span class=o>-&gt;</span><span class=n>num_rows</span> <span class=o>&gt;=</span> <span class=n>TABLE_MAX_ROWS</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=k>return</span> <span class=n>EXECUTE_TABLE_FULL</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>Row</span> <span class=o>*</span><span class=n>row_to_insert</span> <span class=o>=</span> <span class=o>&amp;</span><span class=p>(</span><span class=n>statement</span><span class=o>-&gt;</span><span class=n>row_to_insert</span><span class=p>);</span>

  <span class=n>serialize_row</span><span class=p>(</span><span class=n>row_to_insert</span><span class=p>,</span> <span class=n>row_slot</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>table</span><span class=o>-&gt;</span><span class=n>num_rows</span><span class=p>));</span>
  <span class=n>table</span><span class=o>-&gt;</span><span class=n>num_rows</span> <span class=o>+=</span> <span class=mi>1</span><span class=p>;</span>

  <span class=k>return</span> <span class=n>EXECUTE_SUCCESS</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>ExecuteResult</span> <span class=nf>execute_select</span><span class=p>(</span><span class=n>Statement</span> <span class=o>*</span><span class=n>statement</span><span class=p>,</span> <span class=n>Table</span> <span class=o>*</span><span class=n>table</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>Row</span> <span class=n>row</span><span class=p>;</span>
  <span class=k>for</span> <span class=p>(</span><span class=n>uint32_t</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>table</span><span class=o>-&gt;</span><span class=n>num_rows</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=n>deserialize_row</span><span class=p>(</span><span class=n>row_slot</span><span class=p>(</span><span class=n>table</span><span class=p>,</span> <span class=n>i</span><span class=p>),</span> <span class=o>&amp;</span><span class=n>row</span><span class=p>);</span>
    <span class=n>print_row</span><span class=p>(</span><span class=o>&amp;</span><span class=n>row</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>EXECUTE_SUCCESS</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>ExecuteResult</span> <span class=nf>execute_statement</span><span class=p>(</span><span class=n>Statement</span> <span class=o>*</span><span class=n>statement</span><span class=p>,</span> <span class=n>Table</span> <span class=o>*</span><span class=n>table</span><span class=p>)</span>
<span class=p>{</span>
  <span class=k>switch</span> <span class=p>(</span><span class=n>statement</span><span class=o>-&gt;</span><span class=n>type</span><span class=p>)</span>
  <span class=p>{</span>
  <span class=k>case</span> <span class=p>(</span><span class=n>STATEMENT_INSERT</span><span class=p>)</span><span class=o>:</span>
    <span class=k>return</span> <span class=n>execute_insert</span><span class=p>(</span><span class=n>statement</span><span class=p>,</span> <span class=n>table</span><span class=p>);</span>
  <span class=k>case</span> <span class=p>(</span><span class=n>STATEMENT_SELECT</span><span class=p>)</span><span class=o>:</span>
    <span class=k>return</span> <span class=n>execute_select</span><span class=p>(</span><span class=n>statement</span><span class=p>,</span> <span class=n>table</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>print_prompt</span><span class=p>()</span> <span class=p>{</span> <span class=n>printf</span><span class=p>(</span><span class=s>&#34;db &gt; &#34;</span><span class=p>);</span> <span class=p>}</span>

<span class=kt>void</span> <span class=nf>read_input</span><span class=p>(</span><span class=n>InputBuffer</span> <span class=o>*</span><span class=n>input_buffer</span><span class=p>)</span>
<span class=p>{</span>
  <span class=n>ssize_t</span> <span class=n>bytes_read</span> <span class=o>=</span>
      <span class=n>getline</span><span class=p>(</span><span class=o>&amp;</span><span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>),</span> <span class=o>&amp;</span><span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer_length</span><span class=p>),</span> <span class=n>stdin</span><span class=p>);</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>bytes_read</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Error reading input</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
    <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_FAILURE</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// Ignore trailing newline
</span><span class=c1></span>  <span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>input_length</span> <span class=o>=</span> <span class=n>bytes_read</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
  <span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>[</span><span class=n>bytes_read</span> <span class=o>-</span> <span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<span class=p>}</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>argv</span><span class=p>[])</span>
<span class=p>{</span>
  <span class=n>Table</span> <span class=o>*</span><span class=n>table</span> <span class=o>=</span> <span class=n>new_table</span><span class=p>();</span>
  <span class=n>InputBuffer</span> <span class=o>*</span><span class=n>input_buffer</span> <span class=o>=</span> <span class=n>new_input_buffer</span><span class=p>();</span>
  <span class=k>while</span> <span class=p>(</span><span class=nb>true</span><span class=p>)</span>
  <span class=p>{</span>
    <span class=n>print_prompt</span><span class=p>();</span>
    <span class=n>read_input</span><span class=p>(</span><span class=n>input_buffer</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=sc>&#39;.&#39;</span><span class=p>)</span>
    <span class=p>{</span>
      <span class=k>switch</span> <span class=p>(</span><span class=n>do_meta_command</span><span class=p>(</span><span class=n>input_buffer</span><span class=p>,</span> <span class=n>table</span><span class=p>))</span>
      <span class=p>{</span>
      <span class=k>case</span> <span class=p>(</span><span class=n>META_COMMAND_SUCCESS</span><span class=p>)</span><span class=o>:</span>
        <span class=k>continue</span><span class=p>;</span>
      <span class=k>case</span> <span class=p>(</span><span class=n>META_COMMAND_UNRECOGNIZED_COMMAND</span><span class=p>)</span><span class=o>:</span>
        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Unrecognized command &#39;%s&#39;</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>);</span>
        <span class=k>continue</span><span class=p>;</span>
      <span class=p>}</span>
    <span class=p>}</span>

    <span class=n>Statement</span> <span class=n>statement</span><span class=p>;</span>
    <span class=k>switch</span> <span class=p>(</span><span class=n>prepare_statement</span><span class=p>(</span><span class=n>input_buffer</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>statement</span><span class=p>))</span>
    <span class=p>{</span>
    <span class=k>case</span> <span class=p>(</span><span class=n>PREPARE_SUCCESS</span><span class=p>)</span><span class=o>:</span>
      <span class=k>break</span><span class=p>;</span>
    <span class=k>case</span> <span class=p>(</span><span class=n>PREPARE_NEGATIVE_ID</span><span class=p>)</span><span class=o>:</span>
      <span class=n>printf</span><span class=p>(</span><span class=s>&#34;ID must be positive.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
      <span class=k>continue</span><span class=p>;</span>
    <span class=k>case</span> <span class=p>(</span><span class=n>PREPARE_STRING_TOO_LONG</span><span class=p>)</span><span class=o>:</span>
      <span class=n>printf</span><span class=p>(</span><span class=s>&#34;String is too long.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
      <span class=k>continue</span><span class=p>;</span>
    <span class=k>case</span> <span class=p>(</span><span class=n>PREPARE_SYNTAX_ERROR</span><span class=p>)</span><span class=o>:</span>
      <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Syntax error. Could not parse statement.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
      <span class=k>continue</span><span class=p>;</span>
    <span class=k>case</span> <span class=p>(</span><span class=n>PREPARE_UNRECOGNIZED_STATEMENT</span><span class=p>)</span><span class=o>:</span>
      <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Unrecognized keyword at start of &#39;%s&#39;.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
             <span class=n>input_buffer</span><span class=o>-&gt;</span><span class=n>buffer</span><span class=p>);</span>
      <span class=k>continue</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>switch</span> <span class=p>(</span><span class=n>execute_statement</span><span class=p>(</span><span class=o>&amp;</span><span class=n>statement</span><span class=p>,</span> <span class=n>table</span><span class=p>))</span>
    <span class=p>{</span>
    <span class=k>case</span> <span class=p>(</span><span class=n>EXECUTE_SUCCESS</span><span class=p>)</span><span class=o>:</span>
      <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Executed.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
      <span class=k>break</span><span class=p>;</span>
    <span class=k>case</span> <span class=p>(</span><span class=n>EXECUTE_TABLE_FULL</span><span class=p>)</span><span class=o>:</span>
      <span class=n>printf</span><span class=p>(</span><span class=s>&#34;Error: Table full.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
      <span class=k>break</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span></code></pre></td></tr></table></div></div></figure><p>And we added tests:</p><figure class=code><figcaption><h2>part4.rb</h2></figcaption><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-rb data-lang=rb><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span><span class=lnt>93
</span><span class=lnt>94
</span><span class=lnt>95
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-rb data-lang=rb>
<span class=c1>#!/usr/bin/env ruby</span>

<span class=nb>puts</span> <span class=s2>&#34;$0            : </span><span class=si>#{</span><span class=vg>$0</span><span class=si>}</span><span class=s2>&#34;</span>
<span class=nb>puts</span> <span class=s2>&#34;__FILE__      : </span><span class=si>#{</span><span class=bp>__FILE__</span><span class=si>}</span><span class=s2>&#34;</span>
<span class=nb>puts</span> <span class=s2>&#34;$PROGRAM_NAME : </span><span class=si>#{</span><span class=vg>$PROGRAM_NAME</span><span class=si>}</span><span class=s2>&#34;</span>
<span class=nb>puts</span> <span class=s2>&#34;FILENAME&#34;</span><span class=p>:</span> <span class=no>File</span><span class=o>.</span><span class=n>basename</span><span class=p>(</span><span class=bp>__FILE__</span><span class=p>,</span> <span class=no>File</span><span class=o>.</span><span class=n>extname</span><span class=p>(</span><span class=bp>__FILE__</span><span class=p>))</span>

<span class=n>describe</span> <span class=s1>&#39;database&#39;</span> <span class=k>do</span>
  <span class=k>def</span> <span class=nf>run_script</span><span class=p>(</span><span class=n>commands</span><span class=p>)</span>
    <span class=n>base</span> <span class=o>=</span> <span class=no>File</span><span class=o>.</span><span class=n>basename</span><span class=p>(</span><span class=bp>__FILE__</span><span class=p>,</span> <span class=no>File</span><span class=o>.</span><span class=n>extname</span><span class=p>(</span><span class=bp>__FILE__</span><span class=p>))</span>
    <span class=n>raw_output</span> <span class=o>=</span> <span class=kp>nil</span>
    <span class=no>IO</span><span class=o>.</span><span class=n>popen</span><span class=p>(</span><span class=s2>&#34;./db </span><span class=si>#{</span><span class=n>base</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=s2>&#34;r+&#34;</span><span class=p>)</span> <span class=k>do</span> <span class=o>|</span><span class=n>pipe</span><span class=o>|</span>
      <span class=n>commands</span><span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>command</span><span class=o>|</span>
        <span class=n>pipe</span><span class=o>.</span><span class=n>puts</span> <span class=n>command</span>
      <span class=k>end</span>

      <span class=n>pipe</span><span class=o>.</span><span class=n>close_write</span>

      <span class=c1># Read entire output</span>
      <span class=n>raw_output</span> <span class=o>=</span> <span class=n>pipe</span><span class=o>.</span><span class=n>gets</span><span class=p>(</span><span class=kp>nil</span><span class=p>)</span>
    <span class=k>end</span>
    <span class=n>raw_output</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
  <span class=k>end</span>

  <span class=n>it</span> <span class=s1>&#39;inserts and retreives a row&#39;</span> <span class=k>do</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>run_script</span><span class=p>(</span><span class=o>[</span>
      <span class=s2>&#34;insert 1 user1 person1@example.com&#34;</span><span class=p>,</span>
      <span class=s2>&#34;select&#34;</span><span class=p>,</span>
      <span class=s2>&#34;.exit&#34;</span><span class=p>,</span>
    <span class=o>]</span><span class=p>)</span>
    <span class=n>expect</span><span class=p>(</span><span class=n>result</span><span class=p>)</span><span class=o>.</span><span class=n>to</span> <span class=n>match_array</span><span class=p>(</span><span class=o>[</span>
      <span class=s2>&#34;db &gt; Executed.&#34;</span><span class=p>,</span>
      <span class=s2>&#34;db &gt; (1, user1, person1@example.com)&#34;</span><span class=p>,</span>
      <span class=s2>&#34;Executed.&#34;</span><span class=p>,</span>
      <span class=s2>&#34;db &gt; &#34;</span><span class=p>,</span>
    <span class=o>]</span><span class=p>)</span>
  <span class=k>end</span>

  <span class=n>it</span> <span class=s1>&#39;prints error message when table is full&#39;</span> <span class=k>do</span>
    <span class=n>script</span> <span class=o>=</span> <span class=p>(</span><span class=mi>1</span><span class=o>..</span><span class=mi>1401</span><span class=p>)</span><span class=o>.</span><span class=n>map</span> <span class=k>do</span> <span class=o>|</span><span class=n>i</span><span class=o>|</span>
      <span class=s2>&#34;insert </span><span class=si>#{</span><span class=n>i</span><span class=si>}</span><span class=s2> user</span><span class=si>#{</span><span class=n>i</span><span class=si>}</span><span class=s2> person</span><span class=si>#{</span><span class=n>i</span><span class=si>}</span><span class=s2>@example.com&#34;</span>
    <span class=k>end</span>
    <span class=n>script</span> <span class=o>&lt;&lt;</span> <span class=s2>&#34;.exit&#34;</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>run_script</span><span class=p>(</span><span class=n>script</span><span class=p>)</span>
    <span class=n>expect</span><span class=p>(</span><span class=n>result</span><span class=o>[-</span><span class=mi>2</span><span class=o>]</span><span class=p>)</span><span class=o>.</span><span class=n>to</span> <span class=n>eq</span><span class=p>(</span><span class=s1>&#39;db &gt; Error: Table full.&#39;</span><span class=p>)</span>
  <span class=k>end</span>

  <span class=n>it</span> <span class=s1>&#39;allows inserting strings that are the maximum length&#39;</span> <span class=k>do</span>
    <span class=n>long_username</span> <span class=o>=</span> <span class=s2>&#34;a&#34;</span><span class=o>*</span><span class=mi>32</span>
    <span class=n>long_email</span> <span class=o>=</span> <span class=s2>&#34;a&#34;</span><span class=o>*</span><span class=mi>255</span>
    <span class=n>script</span> <span class=o>=</span> <span class=o>[</span>
      <span class=s2>&#34;insert 1 </span><span class=si>#{</span><span class=n>long_username</span><span class=si>}</span><span class=s2> </span><span class=si>#{</span><span class=n>long_email</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
      <span class=s2>&#34;select&#34;</span><span class=p>,</span>
      <span class=s2>&#34;.exit&#34;</span><span class=p>,</span>
    <span class=o>]</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>run_script</span><span class=p>(</span><span class=n>script</span><span class=p>)</span>
    <span class=n>expect</span><span class=p>(</span><span class=n>result</span><span class=p>)</span><span class=o>.</span><span class=n>to</span> <span class=n>match_array</span><span class=p>(</span><span class=o>[</span>
      <span class=s2>&#34;db &gt; Executed.&#34;</span><span class=p>,</span>
      <span class=s2>&#34;db &gt; (1, </span><span class=si>#{</span><span class=n>long_username</span><span class=si>}</span><span class=s2>, </span><span class=si>#{</span><span class=n>long_email</span><span class=si>}</span><span class=s2>)&#34;</span><span class=p>,</span>
      <span class=s2>&#34;Executed.&#34;</span><span class=p>,</span>
      <span class=s2>&#34;db &gt; &#34;</span><span class=p>,</span>
    <span class=o>]</span><span class=p>)</span>
  <span class=k>end</span>

  <span class=n>it</span> <span class=s1>&#39;prints error message if strings are too long&#39;</span> <span class=k>do</span>
    <span class=n>long_username</span> <span class=o>=</span> <span class=s2>&#34;a&#34;</span><span class=o>*</span><span class=mi>33</span>
    <span class=n>long_email</span> <span class=o>=</span> <span class=s2>&#34;a&#34;</span><span class=o>*</span><span class=mi>256</span>
    <span class=n>script</span> <span class=o>=</span> <span class=o>[</span>
      <span class=s2>&#34;insert 1 </span><span class=si>#{</span><span class=n>long_username</span><span class=si>}</span><span class=s2> </span><span class=si>#{</span><span class=n>long_email</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
      <span class=s2>&#34;select&#34;</span><span class=p>,</span>
      <span class=s2>&#34;.exit&#34;</span><span class=p>,</span>
    <span class=o>]</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>run_script</span><span class=p>(</span><span class=n>script</span><span class=p>)</span>
    <span class=n>expect</span><span class=p>(</span><span class=n>result</span><span class=p>)</span><span class=o>.</span><span class=n>to</span> <span class=n>match_array</span><span class=p>(</span><span class=o>[</span>
      <span class=s2>&#34;db &gt; String is too long.&#34;</span><span class=p>,</span>
      <span class=s2>&#34;db &gt; Executed.&#34;</span><span class=p>,</span>
      <span class=s2>&#34;db &gt; &#34;</span><span class=p>,</span>
    <span class=o>]</span><span class=p>)</span>
  <span class=k>end</span>

  <span class=n>it</span> <span class=s1>&#39;prints an error message if id is negative&#39;</span> <span class=k>do</span>
    <span class=n>script</span> <span class=o>=</span> <span class=o>[</span>
      <span class=s2>&#34;insert -1 cstack foo@bar.com&#34;</span><span class=p>,</span>
      <span class=s2>&#34;select&#34;</span><span class=p>,</span>
      <span class=s2>&#34;.exit&#34;</span><span class=p>,</span>
    <span class=o>]</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>run_script</span><span class=p>(</span><span class=n>script</span><span class=p>)</span>
    <span class=n>expect</span><span class=p>(</span><span class=n>result</span><span class=p>)</span><span class=o>.</span><span class=n>to</span> <span class=n>match_array</span><span class=p>(</span><span class=o>[</span>
      <span class=s2>&#34;db &gt; ID must be positive.&#34;</span><span class=p>,</span>
      <span class=s2>&#34;db &gt; Executed.&#34;</span><span class=p>,</span>
      <span class=s2>&#34;db &gt; &#34;</span><span class=p>,</span>
    <span class=o>]</span><span class=p>)</span>
  <span class=k>end</span>
<span class=k>end</span></code></pre></td></tr></table></div></div></figure><div class=edit-meta><br><a href=https://github.com/stanzheng/build-a-db/edit/master/content/using_c/part4.md class=edit-page><i class="fas fa-pen-square"></i>Edit on GitHub</a></div><nav class=pagination><a class="nav nav-prev" href=/using_c/part3/ title="Part 3 - An In-Memory, Append-Only, Single-Table Database"><i class="fas fa-arrow-left" aria-hidden=true></i>Prev - Part 3 - An In-Memory, Append-Only, Single-Table Database</a>
<a class="nav nav-next" href=/using_c/part5/ title="Part 5 - Persistence to Disk">Next - Part 5 - Persistence to Disk <i class="fas fa-arrow-right" aria-hidden=true></i></a></nav><footer><p class=powered>Powered by <a href=https://gohugo.io>Hugo</a>. Theme by <a href=https://themes.gohugo.io/hugo-theme-techdoc/>TechDoc</a>. Designed by <a href=https://github.com/thingsym/hugo-theme-techdoc>Thingsym</a>.</p></footer></main><div class=sidebar><nav class=open-menu><ul><li><a href=https://build-a-db.stanzheng.com/>Home</a></li><li class=parent><a href=/using_c/>How Does a Database Work? In [C]</a><ul class=sub-menu><li><a href=/using_c/part1/>Part 1 - Introduction and Setting up the REPL</a></li><li><a href=/using_c/part2/>Part 2 - World&#39;s Simplest SQL Compiler and Virtual Machine</a></li><li><a href=/using_c/part3/>Part 3 - An In-Memory, Append-Only, Single-Table Database</a></li><li class=active><a href=/using_c/part4/>Part 4 - Our First Tests (and Bugs)</a></li><li><a href=/using_c/part5/>Part 5 - Persistence to Disk</a></li><li><a href=/using_c/part6/>Part 6 - The Cursor Abstraction</a></li><li><a href=/using_c/part7/>Part 7 - Introduction to the B-Tree</a></li><li><a href=/using_c/part8/>Part 8 - B-Tree Leaf Node Format</a></li><li><a href=/using_c/part9/>Part 9 - Binary Search and Duplicate Keys</a></li><li><a href=/using_c/part10/>Part 10 - Splitting a Leaf Node</a></li><li><a href=/using_c/part11/>Part 11 - Recursively Searching the B-Tree</a></li><li><a href=/using_c/part12/>Part 12 - Scanning a Multi-Level B-Tree</a></li><li><a href=/using_c/part13/>Part 13 - Updating Parent Node After a Split</a></li></ul></li><li><a href=/using_python/>How Does a Database Work? In [Python]</a><ul class=sub-menu><li><a href=/using_python/part1/>Part 1 - Introduction and Setting up the REPL</a></li><li><a href=/using_python/part2/>Part 2 - World&#39;s Simplest SQL Compiler and Virtual Machine</a></li><li><a href=/using_python/part3/>Part 3 - An In-Memory, Append-Only, Single-Table Database</a></li><li><a href=/using_python/code/part4/>Part 4 - Our First Tests (and Bugs)</a></li></ul></li></ul></nav><div class=sidebar-footer></div></div></div><a href=# id=backtothetop-fixed class=backtothetop data-backtothetop-duration=600 data-backtothetop-easing=easeOutQuart data-backtothetop-fixed-fadein=1000 data-backtothetop-fixed-fadeout=1000 data-backtothetop-fixed-bottom=10 data-backtothetop-fixed-right=20><span class="fa-layers fa-fw"><i class="fas fa-circle"></i><i class="fas fa-arrow-circle-up"></i></span></a></div></body></html>